<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <title>Loop needed for javascript function</title>
  <link rel="stylesheet" type="text/css" href="/css/base.css">
  <script type="text/x-mathjax-config">
            MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
            tex2jax: { inlineMath: [ ["$", "$"], ["\\\\(","\\\\)"] ], displayMath: [ ["$$","$$"], ["\\[", "\\]"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno" },
            TeX: {
            extensions: ["begingroup.js"],
            noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
            Macros: { href: "{}" }
            },
            messageStyle: "none",
            styles: { ".MathJax_Display, .MathJax_Preview, .MathJax_Preview > *": { "background": "inherit" } },
            SEEditor: "mathjaxEditing"
            });
        </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full"></script>
 </head>
 <body>
  <div class="question">
   <a href="/questions">All Questions</a>
   <h2>Loop needed for javascript function</h2>
   <div class="container-metadata">
    <div>
     <span>Score: </span> <span>0</span>
    </div>
    <div>
     <span>Asker: </span> <span>user1135218</span>
    </div>
    <div>
     <span>Asked: </span> <span>25 Mar 2023 at 12:56</span>
    </div>
    <div>
     <a href="https://stackoverflow.com/questions/75841834/loop-needed-for-javascript-function">source</a>
    </div>
   </div>
   <div>
    <p>I am using datatables and when row is clicked, I want to show details table just below. Code works fine, but I am trying to populate the Details Table (when row clicked) with data from a field in the row which I need splitted.</p>
    <p>Here is the code... The var names = d[11] is the field which I need splitted then shown below. The code below works fine, but the details table created is just dummy data... I have not been able to create the loop to put the different 'charges' within the splitted string</p>
    <p>In summary, each string which needs to be splitted, needs to be separated first by | character. Then each 'charge' needs to be separated by the ^ character and put on each table cell to display it like the current dummy data. Each record row/string to split can have a different number of charges (separated by |). So not all have the same (some have 2 charges, other 5 charges, other 10 charges)</p>
    <p>Look forward to your comments.</p>
    <p>code:</p>
    <pre><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;script src="https://code.jquery.com/jquery-1.11.3.min.js"&gt;&lt;/script&gt;
&lt;link href="https://nightly.datatables.net/css/jquery.dataTables.css" rel="stylesheet" type="text/css" /&gt;
&lt;script src="https://nightly.datatables.net/js/jquery.dataTables.js"&gt;&lt;/script&gt;
&lt;meta Content-Type: text/html; charset=ISO-8859-1&gt;
&lt;title&gt;INTERMODAL&lt;/title&gt;
&lt;/head&gt;
&lt;BODY&gt;
&lt;style&gt;

td.dt-control {
  background: url("https://www.datatables.net/examples/resources/details_open.png") no-repeat center center;
  cursor: pointer;
}
 
tr.dt-hasChild td.dt-control {
  background: url("https://www.datatables.net/examples/resources/details_close.png") no-repeat center center;
}


.dataTables_wrapper {float: none; text-align:left; font-family: Verdana, Geneva, Tahoma; font-size: 13px;}
&lt;/style&gt;
&lt;h3 style='font-family:arial,georgia,garamond,serif;'&gt;DATABASE (06-mar-23 15:12)&lt;/h3&gt;
&lt;h4 style='font-family:arial,georgia,garamond,serif;'&gt;You can search by Location Name or ZipCode&lt;/h4&gt;
&lt;div class='demo-html' style=width:70%&gt;
&lt;table id='example' width='100%' class='table compact stripe'&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;script&gt;


/* Formatting function for row details - modify as you need */
function format ( d ) {

    //  HERE IS AN EXAMPLE OF WHAT THE STRING THAT NEEDS TO BE SPLITTED FIRST BY |THEN BY ^ LOOKS KIKE....
    //d[11] = 'Taxes and Duties^150^150^150^USD|Handling Charge^111^111^111^USD|Destination Charges^111^111^111^USD'
   
    var names = d[11]
    var nameArr = names.split('|');
    var names2 =nameArr[1]
    var nameArr2 = names2.split('^');    

    // LOOP NEEDED TO LOOP BY NameArr, then again by NameArr2 and add to table

    return '&lt;table cellpadding="5" cellspacing="0" border="0" style="padding-left:750px;"&gt;'+
    
// this table creation is dummy code, which I tried several way but couldn't work it out

    
    '&lt;tr&gt;'+
            '&lt;td style="width:150px;bold:true;"&gt;Charge Description&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;CUR&lt;/td&gt;'+
            '&lt;td style="width:50px;"&gt;20GE&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;40GE&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;40HC&lt;/td&gt;'+
            '&lt;td style="width:50px;"&gt;basis&lt;/td&gt;'+
        '&lt;/tr&gt;'+    
        '&lt;tr&gt;'+         
        '&lt;td style="width:150px;"&gt;Freight&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;USD&lt;/td&gt;'+
            '&lt;td style="width:50px;"&gt;1500&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;2500&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;2500&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;CNTR&lt;/td&gt;'+
        '&lt;/tr&gt;'+
        '&lt;tr&gt;'+
            '&lt;td&gt;Origin Charge&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;USD&lt;/td&gt;'+
            '&lt;td&gt;150&lt;/td&gt;'+
            '&lt;td&gt;300&lt;/td&gt;'+
            '&lt;td&gt;300&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;CNTR&lt;/td&gt;'+
        '&lt;/tr&gt;'+
        '&lt;tr&gt;'+
            '&lt;td&gt;Middle Charges&lt;/td&gt;'+
'&lt;td style="width:50px;"&gt;EUR&lt;/td&gt;'+
            '&lt;td&gt;150&lt;/td&gt;'+
            '&lt;td&gt;300&lt;/td&gt;'+
            '&lt;td&gt;300&lt;/td&gt;'+     
        '&lt;td style="width:50px;"&gt;CNTR&lt;/td&gt;'+       
        '&lt;/tr&gt;'+
    '&lt;tr&gt;'+
             '&lt;td&gt;Other Charges&lt;/td&gt;'+
'&lt;td style="width:50px;"&gt;USD&lt;/td&gt;'+
            '&lt;td&gt;150&lt;/td&gt;'+
            '&lt;td&gt;300&lt;/td&gt;'+
            '&lt;td&gt;300&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;CNTR&lt;/td&gt;'+
        '&lt;/tr&gt;'+
    '&lt;tr&gt;'+
            '&lt;td&gt;'+nameArr2[0]+'&lt;/td&gt;'+
        '&lt;td&gt;'+nameArr2[4]+'&lt;/td&gt;'+
            '&lt;td&gt;'+nameArr2[1]+'&lt;/td&gt;'+
            '&lt;td&gt;'+nameArr2[2]+'&lt;/td&gt;'+
            '&lt;td&gt;'+nameArr2[3]+'&lt;/td&gt;'+
        '&lt;td style="width:50px;"&gt;CNTR&lt;/td&gt;'+
        '&lt;/tr&gt;'+

    '&lt;/table&gt;';
}      

var IntermodalSet = [
['Algeciras', '(CADIZ)', 'ES-11201;ES-11202;ES-11203;ES-11204;ES-11205;ES-11206;ES-11207;ES-11390;ES-11391', '5', 'ALGECIRAS', 'MAIN PORT', 'EUR', '€100', '€100' , '€100', '', 'Taxes and Duties^150^150^150^USD|Handling Charge^111^111^111^USD|Destination Charges^111^111^111^USD'], 
['SAN ROQUE ', '(CADIZ)', 'ES-11310;ES-11311;ES-11312;ES-11313;ES-11314;ES-11360;ES-11368;ES-11369', '15', 'ALGECIRAS', 'MAIN PORT', 'EUR', '€100', '€100' , '€100', '', 'Taxes and Duties^150^150^150^USD|Handling Charge^111^111^111^USD|Destination Charges^111^111^111^USD'],
['CASTELLAR DE LA FRONTERA', '(CADIZ)', 'ES-11350', '26', 'ALGECIRAS', 'MAIN PORT', 'EUR', '€100', '€100' , '€100', '', 'Taxes and Duties^150^150^150^USD|Handling Charge^111^111^111^USD|Destination Charges^111^111^111^USD'],
['LOS BARRIOS', '(CADIZ)', 'ES-11370;ES-11379', '21', 'ALGECIRAS', 'MAIN PORT', 'EUR','€100', '€100' , '€100', '', 'Taxes and Duties^150^150^150^USD|Handling Charge^111^111^111^USD|Destination Charges^111^111^111^USD'],
['JIMENA DE LA FRONTERA', '(CADIZ)', 'ES-11320;ES-11330;ES-11339;ES-11340', '42', 'ALGECIRAS', 'MAIN PORT', 'EUR', '€100', '€100' , '€100', '', 'Taxes and Duties^150^150^150^USD|Handling Charge^111^111^111^USD|Destination Charges^111^111^111^USD'],
['CASARES', '(MALAGA)', 'ES-29690;ES-29692', '55', 'ALGECIRAS', 'MAIN PORT', 'EUR', '€100', '€100' , '€100', '', 'Taxes and Duties^150^150^150^USD|Handling Charge^111^111^111^USD|Destination Charges^111^111^111^USD|Additional Charges^30^60^60^USD'],
];
  
    
$(document).ready(function () {
var table =$('#example').DataTable({
'bFilter':true,
'pageLength': 20, 
data: IntermodalSet,
'order': [[ 2, 'asc' ], [ 8, 'asc' ]], 
columns: [
    { title: 'LOCATION' },
    { title: '(PROVINCE)' },
    { title: 'ZIPCODE' },
    { title: 'KMS' },
    { title: 'PORT' },
    { title: 'MAIN' },
    { title: 'CUR' },
    { title: 'PRICE1' },
    { title: 'PRICE2' },
    { title: 'PRICE3' },
    { title: 'TOLL' },
    { title: 'ALLIN' },
    { title: 'Details', className: 'dt-control', orderable: false, data: null, defaultContent: '',},
    
 ],
'bAutoWidth': false, 
'dom': 'Qlfrtip',

'columnDefs': [{searchBuilder: {defaultCondition: '='},targets:[0]}],

'columnDefs': [

               {'width':'20%'  , visible: true, 'targets':[0], 'searchable': true }, 
               {'width':'100px', visible: true, 'targets':[1],  'searchable': false}, 
               {'width':'23%'  , visible: true, 'targets': [2], 'searchable': true},  
               {'width':'25px' , visible: true, 'targets':[3],  'searchable': false, className:'dt-right'},  
               {'width':'0px'  , visible: false, 'targets':[6], 'searchable': false, className:'dt-right'} , 
               {'width':'100px', visible: true,  'targets':[4], 'searchable': false} , 
               {'width':'0px'  , visible: false, 'targets':[5],  'searchable': false} , 
               {'width':'65px' , visible: true,  'targets': [7,8,9,10], 'searchable': false, className:'dt-right'},  
           {'width':'1px' , visible: false, 'targets': [11], 'searchable': false, className:'dt-right'}, 
        
            
], 
 });

 // Add event listener for opening and closing details
    $('#example tbody').on('click', 'td.dt-control', function () {
        
        var tr = $(this).closest('tr');
        var row = table.row(tr);

        if (row.child.isShown()) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        } else {            
            // Open this row
            row.child(format(row.data())).show();
            tr.addClass('shown');
        }
    });
   

});    

&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>
   </div>
   <div class="tags">
    <span class="tag">javascript</span><span class="tag">loops</span><span class="tag">datatables</span>
   </div>
   <hr>
   <div class="comment">
    <table>
     <tbody>
      <tr>
       <td></td>
       <td><span>There are now <a href="https://developer.mozilla.org/en-US/docs/Learn/Tools_and_testing/Client-side_JavaScript_frameworks" rel="nofollow noreferrer">better ways</a> to construct HTML content dynamically than how your <code>format()</code> function does it.</span> <span> - </span> <span class="display-name">jarmod</span> <span> </span> <span class="date">25 Mar 2023 at 16:23</span></td>
      </tr>
     </tbody>
    </table>
   </div>
   <br>
   <div>
    <h2 id="answer_1"><span>Answer 1</span></h2>
    <div class="container-metadata">
     <div>
      <span>Score: </span> <span>2</span>
     </div>
     <div>
      <span>Answerer: </span> <span>andrewJames</span>
     </div>
     <div>
      <span> Answered: </span> <span>25 Mar 2023 at 16:12</span>
     </div>
    </div>
    <div>
     <p>Here is an example which shows one approach, using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach" rel="nofollow noreferrer"><code>forEach()</code></a>:</p>
     <p></p>
     <div class="snippet" data-lang="js" data-hide="false" data-console="true" data-babel="false">
      <div class="snippet-code">
       <pre class="snippet-code-js lang-js prettyprint-override"><code>// in your case, `sampleInput` will be `d[11]`:
var sampleInput = 'Taxes and Duties^150^150^150^USD|Handling Charge^111^111^111^USD|Destination Charges^111^111^111^USD';

// each new subtable starts with this HTML (header row):
var subTable = '&lt;table&gt;&lt;tr&gt;' +
  '&lt;td style="width:150px;bold:true;"&gt;Charge Description&lt;/td&gt;' +
  '&lt;td style="width:50px;"&gt;CUR&lt;/td&gt;' +
  '&lt;td style="width:50px;"&gt;20GE&lt;/td&gt;' +
  '&lt;td style="width:50px;"&gt;40GE&lt;/td&gt;' +
  '&lt;td style="width:50px;"&gt;40HC&lt;/td&gt;' +
  '&lt;td style="width:50px;"&gt;basis&lt;/td&gt;' +
  '&lt;/tr&gt;';

// the `slice` function ignores the first entry in the array (index 0) and only reads the array from index 1 onwards:
sampleInput.split('|').slice(1).forEach((charge) =&gt; {
  // take each charge line item and create an array:
  var chargeItem = charge.split('^');

  // use the line item fields - the same as you already do:
  subTable = subTable + '&lt;tr&gt;' +
    '&lt;td&gt;' + chargeItem[0] + '&lt;/td&gt;' +
    '&lt;td&gt;' + chargeItem[4] + '&lt;/td&gt;' +
    '&lt;td&gt;' + chargeItem[1] + '&lt;/td&gt;' +
    '&lt;td&gt;' + chargeItem[2] + '&lt;/td&gt;' +
    '&lt;td&gt;' + chargeItem[3] + '&lt;/td&gt;' +
    '&lt;td style="width:50px;"&gt;CNTR&lt;/td&gt;' +
    '&lt;/tr&gt;';
});

subTable = subTable + '&lt;/table&gt;';

// This is what you need to `return` from your `format` function:
console.log(subTable);</code></pre>
      </div>
     </div>
     <p></p>
     <p>I have added comments in the code.</p>
     <p>The code generates HTML as follows (formatted for readability):</p>
     <pre class="lang-html prettyprint-override"><code>&lt;table&gt;
    &lt;tr&gt;
        &lt;td style="width:150px;bold:true;"&gt;Charge Description&lt;/td&gt;
        &lt;td style="width:50px;"&gt;CUR&lt;/td&gt;
        &lt;td style="width:50px;"&gt;20GE&lt;/td&gt;
        &lt;td style="width:50px;"&gt;40GE&lt;/td&gt;
        &lt;td style="width:50px;"&gt;40HC&lt;/td&gt;
        &lt;td style="width:50px;"&gt;basis&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;td&gt;Handling Charge&lt;/td&gt;
        &lt;td&gt;USD&lt;/td&gt;
        &lt;td&gt;111&lt;/td&gt;
        &lt;td&gt;111&lt;/td&gt;
        &lt;td&gt;111&lt;/td&gt;
        &lt;td style="width:50px;"&gt;CNTR&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
        &lt;td&gt;Destination Charges&lt;/td&gt;
        &lt;td&gt;USD&lt;/td&gt;
        &lt;td&gt;111&lt;/td&gt;
        &lt;td&gt;111&lt;/td&gt;
        &lt;td&gt;111&lt;/td&gt;
        &lt;td style="width:50px;"&gt;CNTR&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;
</code></pre>
     <hr>
     <p>The only other change I made was to use UTF-8 here:</p>
     <pre><code>&lt;meta Content-Type: text/html; charset=UTF-8&gt;
</code></pre>
     <p>Without this my Euro symbols were not rendered correctly in the main DataTable.</p>
     <hr>
     <p><strong>Update</strong></p>
     <blockquote>
      <p>I'd expect the table cell construction code such as '' + chargeItem[0] + '' to be vulnerable to HTML injection attacks.</p>
     </blockquote>
     <p>Yes, I failed to mention that.</p>
     <p>DataTables has a <a href="https://www.datatables.net/manual/data/renderers#Text-helper" rel="nofollow noreferrer">render function</a>:</p>
     <pre><code>render: DataTable.render.text()
</code></pre>
     <p>This can be used to:</p>
     <blockquote>
      <p>"<em>ensure that any potentially dangerous HTML in the source data will not be executed by escaping the HTML entities.</em>"</p>
     </blockquote>
     <p>However, there are 2 caveats:</p>
     <ol>
      <li>
       <p>This can be applied to DataTables column data, but not to data returned by functions which build child data (as used in this question).</p></li>
      <li>
       <p>The code behind the render function basically converts selected HTML reserved characters to <a href="https://developer.mozilla.org/en-US/docs/Glossary/Entity" rel="nofollow noreferrer">HTML entitites</a>:</p></li>
     </ol>
     <pre class="lang-js prettyprint-override"><code>d.replace(/&amp;/g, '&amp;amp;')
    .replace(/&lt;/g, '&amp;lt;')
    .replace(/&gt;/g, '&amp;gt;')
    .replace(/"/g, '&amp;quot;') 
</code></pre>
     <p>For all I know there may be loopholes in the above approach.</p>
     <p>For what it's worth (given caveat 2 above) my approach could be improved by using a function:</p>
     <pre class="lang-js prettyprint-override"><code>function escape( d ) {
  return d.replace(/&amp;/g, '&amp;amp;')
            .replace(/&lt;/g, '&amp;lt;')
            .replace(/&gt;/g, '&amp;gt;')
            .replace(/"/g, '&amp;quot;');
}
</code></pre>
     <p>And then using it as follows:</p>
     <pre><code>subTable = subTable + '&lt;tr&gt;' +
    '&lt;td&gt;'+ escape(chargeItem[0]) +'&lt;/td&gt;' +
    '&lt;td&gt;'+ escape(chargeItem[4]) +'&lt;/td&gt;' +
    '&lt;td&gt;'+ escape(chargeItem[1]) +'&lt;/td&gt;' +
    '&lt;td&gt;'+ escape(chargeItem[2]) +'&lt;/td&gt;' +
    '&lt;td&gt;'+ escape(chargeItem[3]) +'&lt;/td&gt;' +
    '&lt;td style="width:50px;"&gt;CNTR&lt;/td&gt;' +
    '&lt;/tr&gt;';
</code></pre>
     <p>I would be interested in know if this approach has weaknesses and if there are more robust solutions.</p>
    </div>
    <hr>
    <div class="comment">
     <table>
      <tbody>
       <tr>
        <td>1</td>
        <td><span>I'd expect the table cell construction code such as <code>'&lt;td&gt;' + chargeItem[0] + '&lt;/td&gt;'</code> to be vulnerable to HTML injection attacks.</span> <span> - </span> <span class="display-name">jarmod</span> <span> </span> <span class="date">25 Mar 2023 at 16:19</span></td>
       </tr>
       <tr>
        <td></td>
        <td><span>wow, what can I say? I am in tears. That was an elegant, short, simple to follow answer! Works perfectly, and it was exactly what I was after. Cannot thank you enough</span> <span> - </span> <span class="display-name">user1135218</span> <span> </span> <span class="date">25 Mar 2023 at 16:50</span></td>
       </tr>
       <tr>
        <td>1</td>
        <td><span>@jarmod - Your point is well taken - thank you. I have added some notes to the answer - but I realize they are almost certainly not a definitive solution - and there are many (many!) alternatives - for example <a href="https://stackoverflow.com/questions/6234773/can-i-escape-html-special-chars-in-javascript">Can I escape HTML special chars in JavaScript?</a>.</span> <span> - </span> <span class="display-name">andrewJames</span> <span> </span> <span class="date">25 Mar 2023 at 17:35</span></td>
       </tr>
       <tr>
        <td>1</td>
        <td><span>I appreciate the additional information about the injection issues. I have used the function escape and works perfectly. Again, cannot thank you enough.</span> <span> - </span> <span class="display-name">user1135218</span> <span> </span> <span class="date">25 Mar 2023 at 17:37</span></td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
   <br>
   <div>
    <span>License: </span> <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> <span>by </span> <a href="https://stackoverflow.com/legal/terms-of-service#licensing">Stack Overflow Inc.</a>
   </div>
  </div>
 </body>
</html>