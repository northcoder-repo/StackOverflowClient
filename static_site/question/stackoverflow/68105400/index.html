<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <title>Google App script for scraping WSJ and Yahoo Finance</title>
  <link rel="stylesheet" type="text/css" href="/css/base.css">
  <script type="text/x-mathjax-config">
            MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
            tex2jax: { inlineMath: [ ["$", "$"], ["\\\\(","\\\\)"] ], displayMath: [ ["$$","$$"], ["\\[", "\\]"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno" },
            TeX: {
            extensions: ["begingroup.js"],
            noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
            Macros: { href: "{}" }
            },
            messageStyle: "none",
            styles: { ".MathJax_Display, .MathJax_Preview, .MathJax_Preview > *": { "background": "inherit" } },
            SEEditor: "mathjaxEditing"
            });
        </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full"></script>
 </head>
 <body>
  <div class="question">
   <a href="/questions">All Questions</a>
   <h2>Google App script for scraping WSJ and Yahoo Finance</h2>
   <div class="container-metadata">
    <div>
     <span>Score: </span> <span>0</span>
    </div>
    <div>
     <span>Asker: </span> <span>Awais Anwar</span>
    </div>
    <div>
     <span>Asked: </span> <span>23 Jun 2021 at 18:33</span>
    </div>
    <div>
     <a href="https://stackoverflow.com/questions/68105400/google-app-script-for-scraping-wsj-and-yahoo-finance">source</a>
    </div>
   </div>
   <div>
    <p>I am trying to pull data from WSJ and yahoofiance using google sheet app script. I was able to pull some data through following code with HTML of current price from following page ie <code>&lt;span id="quote_val"&gt;(.+?)&lt;\/span&gt;</code>....please note that it containing Id .</p>
    <p><a href="https://i.stack.imgur.com/X9knM.png" rel="nofollow noreferrer"><img src="X9knM.png" alt="enter image description here"></a></p>
    <p>Now i am trying to pull target price with HTML of <code>&lt;span class="data_data"&gt;&lt;sup&gt;$&lt;/sup&gt;50.80&lt;/span&gt;</code> . This will not give me desired result . please note that it contains Class not id..</p>
    <p><a href="https://i.stack.imgur.com/liSbm.png" rel="nofollow noreferrer"><img src="liSbm.png" alt="enter image description here"></a></p>
    <p>When we choose url as lets say <a href="https://www.wsj.com/market-data/quotes/PCT/research-ratings" rel="nofollow noreferrer">https://www.wsj.com/market-data/quotes/PCT/research-ratings</a></p>
    <pre><code>function SAMPLE(url) {
  const html = UrlFetchApp.fetch(url).getContentText();
  const res = html.match(/&lt;span id="quote_val"&gt;(.+?)&lt;\/span&gt;/);
  if (!res) throw new Error("Value cannot be retrieved.")
  return isNaN(res[1]) ? res[1] : Number(res[1]);
}
</code></pre>
    <p>Is there a simple solution?</p>
   </div>
   <div class="tags">
    <span class="tag">html</span><span class="tag">google-apps-script</span><span class="tag">web-scraping</span><span class="tag">urlfetch</span><span class="tag">stockquotes</span>
   </div>
   <hr>
   <div class="comment">
    <table>
     <tbody>
      <tr>
       <td></td>
       <td><span>I assume if you can find <code>&lt;span id="quote_val"&gt;</code> successfully, then you should also be able to find <code>&lt;span class="cr_sym"&gt;</code> (or whatever your actual example is) - assuming it's in the HTML response and assuming it's not generated by JavaScript scripts in the web page.</span> <span> - </span> <span class="display-name">andrewJames</span> <span> </span> <span class="date">23 Jun 2021 at 21:17</span></td>
      </tr>
      <tr>
       <td></td>
       <td><span>Url updated. Excuse me for the inconvenience..</span> <span> - </span> <span class="display-name">Awais Anwar</span> <span> </span> <span class="date">26 Jun 2021 at 02:51</span></td>
      </tr>
      <tr>
       <td></td>
       <td><span>OK - thanks for the clarifications. I have provided an approach.</span> <span> - </span> <span class="display-name">andrewJames</span> <span> </span> <span class="date">26 Jun 2021 at 14:37</span></td>
      </tr>
     </tbody>
    </table>
   </div>
   <br>
   <div>
    <h2 id="answer_1"><span>Answer 1</span></h2>
    <div class="container-metadata">
     <div>
      <span>Score: </span> <span>2</span>
     </div>
     <div>
      <span>Answerer: </span> <span>andrewJames</span>
     </div>
     <div>
      <span> Answered: </span> <span>26 Jun 2021 at 14:37</span>
     </div>
    </div>
    <div>
     <p>I would tackle this in two steps:</p>
     <ol>
      <li>
       <p>Use a regular expression to extract the subsection of the web page that you are interested in - specifically the "Stock Price Target" table.</p></li>
      <li>
       <p>Parse that <code>&lt;table&gt;...&lt;/table&gt;</code> string into an HTML document and then iterate over the nodes in that document to extract each relevant item from the table.</p></li>
     </ol>
     <pre class="lang-js prettyprint-override"><code>function scrapeDemo() {
  var url = 'https://www.wsj.com/market-data/quotes/PCT/research-ratings';

  var html = UrlFetchApp.fetch(url).getContentText();
  var res = html.match(/&lt;div class="cr_data rr_stockprice module"&gt;.+?(&lt;table .+?&lt;\/table&gt;)/);

  var document = XmlService.parse(res[1]);
  var root = document.getRootElement();
    
  var trNodes = root.getChild('tbody').getChildren();
  trNodes.forEach((trNode) =&gt; {
    var tdNodes = trNode.getChildren();
    var fieldName;
    var fieldValue;
    tdNodes.forEach((tdNode, idx) =&gt; {
      if (idx % 2 === 0) {
        fieldName = tdNode.getValue().trim();
      } else {
        fieldValue = tdNode.getValue().trim();
        console.log( fieldName + " : " + fieldValue );
      }
    } );
  } );
}
</code></pre>
     <p>The regular expression uses this as its starting point:</p>
     <pre><code>&lt;div class="cr_data rr_stockprice module"&gt;
</code></pre>
     <p>This is because we need a reliably unique element which is a parent of the table we want (the table itself does not contain anything which uniquely identifies it).</p>
     <p>This gives us the table in the <code>res[1]</code> captured group. Here is that HTML:</p>
     <pre class="lang-html prettyprint-override"><code>&lt;table class="cr_dataTable"&gt;
    &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;span class="data_lbl"&gt;High&lt;/span&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;span class="data_data"&gt;
                    &lt;sup&gt;$&lt;/sup&gt;48.00&lt;/span&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;span class="data_lbl"&gt;Median&lt;/span&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;span class="data_data"&gt;
                    &lt;sup&gt;$&lt;/sup&gt;37.50&lt;/span&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;span class="data_lbl"&gt;Low&lt;/span&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;span class="data_data"&gt;
                    &lt;sup&gt;$&lt;/sup&gt;24.00&lt;/span&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr class="highlight"&gt;
            &lt;td&gt;
                &lt;span class="data_lbl"&gt;Average&lt;/span&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;span class="data_data"&gt;
                    &lt;sup&gt;$&lt;/sup&gt;36.75&lt;/span&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
        &lt;tr&gt;
            &lt;td&gt;
                &lt;span class="data_lbl"&gt;Current Price&lt;/span&gt;
            &lt;/td&gt;
            &lt;td&gt;
                &lt;span class="data_data"&gt;
                    &lt;sup&gt;$&lt;/sup&gt;24.18&lt;/span&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/tbody&gt;
&lt;/table&gt;
</code></pre>
     <p>Now we perform step 2 using <code>XmlService.parse()</code> to create a mini-XML document containing our HTML.</p>
     <p>Then we iterate over the elements of that document, by drilling down into each level's child nodes.</p>
     <p>Each field's value is written to the console, so for this table...</p>
     <p><a href="https://i.stack.imgur.com/yM9Nu.png" rel="nofollow noreferrer"><img src="yM9Nu.png" alt="enter image description here"></a></p>
     <p>...we get this data:</p>
     <pre><code>High : $48.00
Median : $37.50
Low : $24.00
Average : $36.75
Current Price : $24.18
</code></pre>
     <hr>
     <p>In my experience, doing this type of scraping can be difficult. Any unexpected changes in web page structure, from one page to another, can cause the regular expression to fail, or cause the drill-down into the table to fail. In other words, this type of approach should work, but it may also break unexpectedly.</p>
    </div>
    <hr>
    <div class="comment">
     <table>
      <tbody>
       <tr>
        <td></td>
        <td><span>Thanks alot. i am new with script but i think i understand the trick used.. i ran function scrapeDemo and it is giving me all the results in log.. I am trying to get this in google sheet cells. When i run function =scrapeDemo() in a cell it gives me a blank cell. Can you help in this also..? Thanks Again.. was very helpful...</span> <span> - </span> <span class="display-name">Awais Anwar</span> <span> </span> <span class="date">27 Jun 2021 at 10:37</span></td>
       </tr>
       <tr>
        <td></td>
        <td><span>"<i>I am trying to get this in google sheet cells</i>" - That is a different problem, which you should ask in a new question. However, that question has been asked many times already, and there are many examples showing how to do that on this site, and <a href="https://developers.google.com/apps-script/guides/sheets" rel="nofollow noreferrer">elsewhere</a>. You can do some research first, and try for yourself. Ask a new question if you are really stuck.</span> <span> - </span> <span class="display-name">andrewJames</span> <span> </span> <span class="date">27 Jun 2021 at 13:41</span></td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
   <br>
   <div>
    <span>License: </span> <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> <span>by </span> <a href="https://stackoverflow.com/legal/terms-of-service#licensing">Stack Overflow Inc.</a>
   </div>
  </div>
 </body>
</html>